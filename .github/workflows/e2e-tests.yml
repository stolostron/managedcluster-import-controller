# Copyright Contributors to the Open Cluster Management project

name: Go

on:
  push:
    branches: [main, release-*, backplane-*]
    paths-ignore:
      - ".tekton/**"
      - "docs/**"
  pull_request:
    branches: [main, release-*, backplane-*]
    paths-ignore:
      - ".tekton/**"
      - "docs/**"

jobs:
  e2e-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.24.0" # default is latest stable
        id: install

      - name: E2E Tests (Core)
        run: OCM_VERSION=${{ github.base_ref }} make e2e-test-core

      - if: ${{ failure() }}
        name: Collect Debug Info after Tests Failed
        run: |
          echo "==== Klusterlet CRs ===="
          kubectl get klusterlets -A -o yaml || true

          echo "==== Klusterlet CRD ===="
          kubectl get crd klusterlets.operator.open-cluster-management.io -o yaml || true

          echo "==== ManifestWorks ===="
          kubectl get manifestworks -A -o yaml || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -A -o yaml || true

          echo "==== ManagedClusters ===="
          kubectl get managedclusters -A -o yaml || true

          echo "==== Managed Cluster Leases ===="
          for ns in $(kubectl get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Leases in namespace: $ns ----"
            kubectl get lease -n "$ns" -o yaml || true
          done

          echo "==== Namespace open-cluster-management-agent ===="
          kubectl get ns open-cluster-management-agent -o yaml || true

          echo "==== Namespace open-cluster-management-local ===="
          kubectl get ns open-cluster-management-local -o yaml || true

          echo "==== Pods in open-cluster-management-agent ===="
          kubectl get pods -n open-cluster-management-agent -o wide || true

          echo "==== Pods in open-cluster-management-local ===="
          kubectl get pods -n open-cluster-management-local -o wide || true

          echo "==== Klusterlet Operator Pods ===="
          kubectl get pods -n open-cluster-management -l app=klusterlet -o wide || true

          echo "==== Events in open-cluster-management-agent ===="
          kubectl get events -n open-cluster-management-agent --sort-by='.lastTimestamp' || true

          echo "==== Events in open-cluster-management ===="
          kubectl get events -n open-cluster-management --sort-by='.lastTimestamp' | tail -50 || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -o yaml || true

          echo "==== Logs from pods in open-cluster-management-agent ===="
          for pod in $(kubectl get pods -n open-cluster-management-agent -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Logs from pods in open-cluster-management-local ===="
          for pod in $(kubectl get pods -n open-cluster-management-local -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Klusterlet Operator Logs ===="
          kubectl -n open-cluster-management logs -l app=klusterlet --tail=500 || true

          echo "==== Import Controller Logs ===="
          kubectl -n open-cluster-management logs -l name=managedcluster-import-controller --tail=100 || true

      - if: ${{ failure() }}
        name: Setup tmate session for debugging
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 30

  e2e-misc:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.24.0" # default is latest stable
        id: install

      - name: E2E Tests (Misc)
        run: OCM_VERSION=${{ github.base_ref }} make e2e-test-misc

      - if: ${{ failure() }}
        name: Collect Debug Info after Tests Failed
        run: |
          echo "==== Klusterlet CRs ===="
          kubectl get klusterlets -A -o yaml || true

          echo "==== Klusterlet CRD ===="
          kubectl get crd klusterlets.operator.open-cluster-management.io -o yaml || true

          echo "==== ManifestWorks ===="
          kubectl get manifestworks -A -o yaml || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -A -o yaml || true

          echo "==== ManagedClusters ===="
          kubectl get managedclusters -A -o yaml || true

          echo "==== Managed Cluster Leases ===="
          for ns in $(kubectl get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Leases in namespace: $ns ----"
            kubectl get lease -n "$ns" -o yaml || true
          done

          echo "==== Namespace open-cluster-management-agent ===="
          kubectl get ns open-cluster-management-agent -o yaml || true

          echo "==== Namespace open-cluster-management-local ===="
          kubectl get ns open-cluster-management-local -o yaml || true

          echo "==== Pods in open-cluster-management-agent ===="
          kubectl get pods -n open-cluster-management-agent -o wide || true

          echo "==== Pods in open-cluster-management-local ===="
          kubectl get pods -n open-cluster-management-local -o wide || true

          echo "==== Klusterlet Operator Pods ===="
          kubectl get pods -n open-cluster-management -l app=klusterlet -o wide || true

          echo "==== Events in open-cluster-management-agent ===="
          kubectl get events -n open-cluster-management-agent --sort-by='.lastTimestamp' || true

          echo "==== Events in open-cluster-management ===="
          kubectl get events -n open-cluster-management --sort-by='.lastTimestamp' | tail -50 || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -o yaml || true

          echo "==== Logs from pods in open-cluster-management-agent ===="
          for pod in $(kubectl get pods -n open-cluster-management-agent -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Logs from pods in open-cluster-management-local ===="
          for pod in $(kubectl get pods -n open-cluster-management-local -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Klusterlet Operator Logs ===="
          kubectl -n open-cluster-management logs -l app=klusterlet --tail=500 || true

          echo "==== Import Controller Logs ===="
          kubectl -n open-cluster-management logs -l name=managedcluster-import-controller --tail=100 || true

      - if: ${{ failure() }}
        name: Setup tmate session for debugging
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 30

  e2e-hosted:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.24.0" # default is latest stable
        id: install

      - name: E2E Tests (Hosted)
        run: OCM_VERSION=${{ github.base_ref }} make e2e-test-hosted

      - if: ${{ failure() }}
        name: Collect Debug Info after Tests Failed
        run: |
          echo "==== Klusterlet CRs ===="
          kubectl get klusterlets -A -o yaml || true

          echo "==== Klusterlet CRD ===="
          kubectl get crd klusterlets.operator.open-cluster-management.io -o yaml || true

          echo "==== ManifestWorks ===="
          kubectl get manifestworks -A -o yaml || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -A -o yaml || true

          echo "==== ManagedClusters ===="
          kubectl get managedclusters -A -o yaml || true

          echo "==== Managed Cluster Leases ===="
          for ns in $(kubectl get managedclusters -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Leases in namespace: $ns ----"
            kubectl get lease -n "$ns" -o yaml || true
          done

          echo "==== Namespace open-cluster-management-agent ===="
          kubectl get ns open-cluster-management-agent -o yaml || true

          echo "==== Namespace open-cluster-management-local ===="
          kubectl get ns open-cluster-management-local -o yaml || true

          echo "==== Pods in open-cluster-management-agent ===="
          kubectl get pods -n open-cluster-management-agent -o wide || true

          echo "==== Pods in open-cluster-management-local ===="
          kubectl get pods -n open-cluster-management-local -o wide || true

          echo "==== Klusterlet Operator Pods ===="
          kubectl get pods -n open-cluster-management -l app=klusterlet -o wide || true

          echo "==== Hosted Klusterlet Namespaces ===="
          kubectl get ns -o name | grep klusterlet- || true

          echo "==== Events in open-cluster-management-agent ===="
          kubectl get events -n open-cluster-management-agent --sort-by='.lastTimestamp' || true

          echo "==== Events in open-cluster-management ===="
          kubectl get events -n open-cluster-management --sort-by='.lastTimestamp' | tail -50 || true

          echo "==== AppliedManifestWorks ===="
          kubectl get appliedmanifestworks -o yaml || true

          echo "==== Logs from pods in open-cluster-management-agent ===="
          for pod in $(kubectl get pods -n open-cluster-management-agent -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-agent "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Logs from pods in open-cluster-management-local ===="
          for pod in $(kubectl get pods -n open-cluster-management-local -o jsonpath='{.items[*].metadata.name}' 2>/dev/null); do
            echo "---- Logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --tail=500 || true
            echo "---- Previous logs from pod: $pod ----"
            kubectl logs -n open-cluster-management-local "$pod" --all-containers --previous --tail=500 || true
          done

          echo "==== Klusterlet Operator Logs ===="
          kubectl -n open-cluster-management logs -l app=klusterlet --tail=500 || true

          echo "==== Import Controller Logs ===="
          kubectl -n open-cluster-management logs -l name=managedcluster-import-controller --tail=100 || true

      - if: ${{ failure() }}
        name: Setup tmate session for debugging
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 30

